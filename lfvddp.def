# Singularity definition file for LFVNN-symmetrized project
# Using CERN CMS Cloud Python VNC image as base
Bootstrap: docker
From: gitlab-registry.cern.ch/cms-cloud/python-vnc:latest

%post
    # Cache-busting commit: PLACEHOLDER
    # Set default values for build arguments
    REPO_URL="${REPO_URL:-https://github.com/eladushiki/lfvddp-symmetrized.git}"
    BRANCH="${BRANCH:-main}"
    CONTAINER_PROJECT_ROOT="${CONTAINER_PROJECT_ROOT:-/app}"
    CONTAINER_CONFIGS_DIR="${CONTAINER_CONFIGS_DIR:-$CONTAINER_PROJECT_ROOT/configs}"
    
    # Install additional system dependencies if needed
    apt-get update && apt-get install -y \
        libffi-dev \
        libssl-dev \
        && rm -rf /var/lib/apt/lists/*

    # Set working directory
    mkdir -p $CONTAINER_PROJECT_ROOT
    cd $CONTAINER_PROJECT_ROOT

    # Clone the repository using build arguments
    echo "Cloning repository: $REPO_URL (branch: $BRANCH)"
    git clone --branch "$BRANCH" --single-branch "$REPO_URL" . && \
    git submodule update --init --recursive && \
    rm -rf .git

    # Install Python dependencies
    pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements.txt

    rm -r $CONTAINER_CONFIGS_DIR

%environment
    export PYTHONUNBUFFERED=1
    export PYTHONPATH=/app

%runscript
    exec /bin/bash "$@"

%labels
    Author LFVNN-symmetrized project
    Version 1.0
    Description Symmetrized DDP research project infrastructure and tools

%help
    This container includes the LFVNN-symmetrized project with all dependencies.
    
    Example:
    set REPO_URL and BRANCH either from within script or by running through submit.py
    singularity build --remote lfvnn.sif lfvnn.def
    
    Usage:
    singularity run lfvnn.sif [command]
    singularity exec lfvnn.sif python train/single_train.py [args]
    
    To copy configs after building:
    singularity exec --bind /path/to/configs:/tmp/configs lfvnn.sif cp -r /tmp/configs /app/configs
    
    The container sets up the Python environment and clones the specified repository and branch.